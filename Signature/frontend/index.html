<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Signature Verification</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 1.2rem; background:#f5f5f8; }
    h1 { margin-top:0; }
    .pane { background:#fff; padding:1rem 1.2rem; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,.08); margin-bottom:1.2rem; }
    label { font-weight:600; }
    input[type=text] { padding:.4rem .6rem; width:220px; }
    button { cursor:pointer; padding:.55rem 1rem; border-radius:5px; border:1px solid #1976d2; background:#1976d2; color:#fff; font-weight:600; }
    button.secondary { background:#555; border-color:#555; }
    button.outline { background:#fff; color:#1976d2; }
    canvas { border:1px solid #999; background:#fff; touch-action:none; }
    .row { display:flex; flex-wrap:wrap; gap:1rem; align-items:center; }
    .samples img { height:70px; margin:4px; border:1px solid #ccc; border-radius:4px; }
    .status { font-family:monospace; white-space:pre-wrap; background:#111; color:#0f0; padding:.75rem; border-radius:6px; max-height:220px; overflow:auto; }
    .flex { display:flex; gap:1rem; }
    .grow { flex:1; }
    .badge { display:inline-block; padding:2px 6px; background:#eee; border-radius:4px; font-size:.75rem; margin-left:6px; }
    .success { color:#0a7d1b; font-weight:700; }
    .fail { color:#c62828; font-weight:700; }
  </style>
</head>
<body>
  <h1>Signature Verification Demo</h1>
  <div class="pane">
    <h2>1. Enter User</h2>
    <div class="row">
      <label>User ID: <input id="userId" type="text" placeholder="e.g. alice" /></label>
      <button onclick="refreshUser()">Load User Data</button>
      <button class="secondary" onclick="purgeUser()" title="Delete all this user's samples">Clear User</button>
      <button class="secondary" onclick="purgeAll()" title="Delete ALL users (confirm=yes)">Clear ALL</button>
    </div>
    <div id="userInfo"></div>
  </div>

  <div class="pane">
    <h2>2. Capture or Upload Samples (Registration)</h2>
    <div class="flex">
      <div>
        <canvas id="pad" width="400" height="180"></canvas><br/>
        <button onclick="clearPad()" class="outline">Clear</button>
        <button onclick="addPadSample()">Add Pad Sample</button>
      </div>
      <div class="grow">
        <input type="file" id="fileInput" accept="image/*" />
        <button onclick="addUploadSample()">Add Upload Sample</button>
        <div id="pendingCount" class="badge">Pending: 0</div>
        <div id="pendingPreview" class="samples"></div>
        <button onclick="submitRegistration()" style="margin-top:.7rem;">Submit Registration</button>
      </div>
    </div>
  </div>

  <div class="pane">
    <h2>3. Verify Signature</h2>
    <div class="flex">
      <div>
        <canvas id="verifyPad" width="400" height="180"></canvas><br/>
        <button onclick="clearVerifyPad()" class="outline">Clear</button>
        <button onclick="verifyFromPad()">Verify (Pad)</button>
      </div>
      <div class="grow">
        <input type="file" id="verifyFile" accept="image/*" />
        <button onclick="verifyFromUpload()">Verify (Upload)</button>
        <div id="verifyResult"></div>
      </div>
    </div>
  </div>

  <div class="pane">
    <h2>4. Registered Samples</h2>
    <div id="registeredSamples" class="samples"></div>
  </div>

  <div class="pane">
    <h2>Logs</h2>
    <div id="log" class="status"></div>
  </div>

<script>
const API_BASE = location.origin; // same host/port
let pendingSamples = [];

function log(msg){
  const el = document.getElementById('log');
  el.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
  el.scrollTop = el.scrollHeight;
}

// Drawing helpers
function makePad(canvasId){
  const c = document.getElementById(canvasId); const ctx = c.getContext('2d');
  ctx.lineWidth = 3; ctx.lineCap = 'round';
  let drawing = false; let stroke = []; let strokes = [];
  function pos(e){ const rect=c.getBoundingClientRect(); if(e.touches){e=e.touches[0];} return {x:e.clientX-rect.left,y:e.clientY-rect.top}; }
  function start(e){ drawing=true; stroke=[]; const p=pos(e); stroke.push({...p,t:Date.now()}); }
  function move(e){ if(!drawing) return; const p=pos(e); const last=stroke[stroke.length-1]; ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); stroke.push({...p,t:Date.now()}); }
  function end(){ if(drawing){ drawing=false; if(stroke.length){ strokes.push(stroke);} } }
  c.addEventListener('mousedown',start); c.addEventListener('mousemove',move); window.addEventListener('mouseup',end);
  c.addEventListener('touchstart',e=>{e.preventDefault();start(e);}); c.addEventListener('touchmove',e=>{e.preventDefault();move(e);}); c.addEventListener('touchend',e=>{e.preventDefault();end(e);});
  return { canvas:c, ctx, clear:()=>{ctx.clearRect(0,0,c.width,c.height); strokes=[];}, get:()=>strokes };
}

const regPad = makePad('pad');
const verifyPad = makePad('verifyPad');

function clearPad(){ regPad.clear(); }
function clearVerifyPad(){ verifyPad.clear(); }

function strokesToPreview(strokes){
  const c=document.createElement('canvas'); c.width=160; c.height=70; const ctx=c.getContext('2d'); ctx.lineWidth=2; ctx.lineCap='round';
  strokes.forEach(str=>{ for(let i=1;i<str.length;i++){ const a=str[i-1], b=str[i]; ctx.beginPath(); ctx.moveTo(a.x/400*160,a.y/180*70); ctx.lineTo(b.x/400*160,b.y/180*70); ctx.stroke(); }});
  return c.toDataURL('image/png');
}

function addPadSample(){
  const strokes = regPad.get();
  if(!strokes.length){ alert('Draw signature first'); return; }
  pendingSamples.push({type:'pad', strokes: JSON.parse(JSON.stringify(strokes)), created: new Date().toISOString()});
  updatePending(); log('Added pad sample.');
  regPad.clear();
}

function addUploadSample(){
  const f = document.getElementById('fileInput').files[0];
  if(!f){ alert('Choose a file'); return; }
  const reader = new FileReader();
  reader.onload = e => {
    pendingSamples.push({type:'upload', image: e.target.result, created: new Date().toISOString()});
    updatePending(); log('Added uploaded image sample.');
  };
  reader.readAsDataURL(f);
}

function updatePending(){
  document.getElementById('pendingCount').textContent = `Pending: ${pendingSamples.length}`;
  const div = document.getElementById('pendingPreview'); div.innerHTML='';
  pendingSamples.forEach(s=>{
    const img=document.createElement('img');
    if(s.strokes){ img.src = strokesToPreview(s.strokes);} else { img.src = s.image; }
    div.appendChild(img);
  });
}

async function submitRegistration(){
  const userId = document.getElementById('userId').value.trim();
  if(!userId){ alert('Enter user id'); return; }
  if(!pendingSamples.length){ alert('No samples to submit'); return; }
  try {
    const res = await fetch(`${API_BASE}/process_signature_registration`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({user_id:userId, samples: pendingSamples})});
    const data = await res.json(); log('Registration response: '+JSON.stringify(data));
    if(data.success){ pendingSamples=[]; updatePending(); refreshUser(); }
  } catch(e){ log('Registration error: '+e); }
}

async function refreshUser(){
  const userId = document.getElementById('userId').value.trim(); if(!userId) return;
  try { const res = await fetch(`${API_BASE}/user/${userId}/signatures`); if(!res.ok){ document.getElementById('userInfo').innerHTML = '<span class="fail">User not found</span>'; document.getElementById('registeredSamples').innerHTML=''; return; }
    const data = await res.json();
    document.getElementById('userInfo').innerHTML = `Registered Count: ${data.count}`;
    const container = document.getElementById('registeredSamples'); container.innerHTML='';
    (data.samples||[]).forEach(s=>{ const img=document.createElement('img'); const fn = s.path.split(/[/\\]/).pop(); img.src=`${API_BASE}/registered_image/${fn}`; container.appendChild(img); });
  } catch(e){ log('Refresh error: '+e); }
}

async function verifyFromPad(){
  const userId = document.getElementById('userId').value.trim(); if(!userId){ alert('Enter user id'); return; }
  const strokes = verifyPad.get(); if(!strokes.length){ alert('Draw signature first'); return; }
  try { const res = await fetch(`${API_BASE}/verify_signature`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({user_id:userId, strokes})}); const data = await res.json(); showVerify(data); log('Verify pad response: '+JSON.stringify(data)); }
  catch(e){ log('Verify pad error: '+e); }
}

async function verifyFromUpload(){
  const userId = document.getElementById('userId').value.trim(); if(!userId){ alert('Enter user id'); return; }
  const f = document.getElementById('verifyFile').files[0]; if(!f){ alert('Choose file'); return; }
  const reader = new FileReader(); reader.onload = async e => {
    try { const res = await fetch(`${API_BASE}/verify_signature`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({user_id:userId, image: e.target.result})}); const data = await res.json(); showVerify(data); log('Verify upload response: '+JSON.stringify(data)); } catch(err){ log('Verify upload error: '+err); }
  }; reader.readAsDataURL(f);
}

function showVerify(data){
  const el = document.getElementById('verifyResult');
  if(!data.success){ el.innerHTML = `<span class='fail'>${data.error||'Error'}</span>`; return; }
  el.innerHTML = `Match: <span class='${data.match?'success':'fail'}'>${data.match}</span><br/>Score: ${data.score?.toFixed(4)}`;
}

async function purgeUser(){
  const userId=document.getElementById('userId').value.trim(); if(!userId){alert('Enter user id');return;}
  if(!confirm('Delete ALL signatures for '+userId+'?')) return;
  try{ const res=await fetch(`${API_BASE}/user/${userId}/signatures`, {method:'DELETE'}); const data=await res.json(); log('Purge user: '+JSON.stringify(data)); refreshUser(); }catch(e){ log('Purge user error: '+e); }
}
async function purgeAll(){
  if(!confirm('DELETE absolutely ALL signatures?')) return;
  try{ const res=await fetch(`${API_BASE}/admin/clear_all_signatures?confirm=yes`, {method:'DELETE'}); const data=await res.json(); log('Purge ALL: '+JSON.stringify(data)); refreshUser(); }catch(e){ log('Purge all error: '+e); }
}
</script>
</body>
</html>
